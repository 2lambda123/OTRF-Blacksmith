{"kind": "Scheduled", "properties": {"description": "'Correlates blocked URLs hosting [malicious] executables with host endpoint data\nto identify potential instances of executables of the same name having been recently run.'\n", "severity": "Medium", "requiredDataConnectors": [{"connectorId": "TrendMicro", "dataTypes": ["CommonSecurityLog"]}, {"connectorId": "SecurityEvents", "dataTypes": ["SecurityEvent"]}], "queryFrequency": "P1D", "queryPeriod": "P1D", "triggerOperator": "GreaterThan", "triggerThreshold": 0, "tactics": ["Execution"], "relevantTechniques": ["T1204"], "query": "\nlet timeframe = 1d;\nlet endpointData = \n(SecurityEvent\n  | where TimeGenerated >= ago(timeframe) \n  | where EventID == 4688\n  | extend shortFileName = tostring(split(NewProcessName, '\\\\')[-1])\n  );\n// Correlate suspect executables seen in TrendMicro rule updates with similar activity on endpoints\nCommonSecurityLog \u200b\n| where TimeGenerated >= ago(timeframe)\u200b\n| where DeviceVendor =~ \"Trend Micro\" \u200b\n| where Activity =~ \"Deny List updated\" \n| where RequestURL endswith \".exe\" \u200b\n| project TimeGenerated, Activity , RequestURL , SourceIP, DestinationIP \u200b\n| extend suspectExeName = tolower(tostring(split(RequestURL, '/')[-1]))\u200b\u200b\n| join (endpointData)\u200b on $left.suspectExeName == $right.shortFileName \n| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIP, AccountCustomEntity = TargetUserName, HostCustomEntity = Computer, URLCustomEntity = RequestURL\n", "displayName": "Network endpoint to host executable correlation", "enabled": true, "suppressionDuration": "PT5H", "suppressionEnabled": false}}